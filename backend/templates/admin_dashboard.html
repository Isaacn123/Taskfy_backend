{% extends "layout.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block main %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Admin Dashboard</h1>
            <p class="text-muted">Welcome, {{ admin.name }} ({{ admin.role }})</p>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Users</h5>
                    <h2 class="card-text">{{ stats.total_users }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Tasks</h5>
                    <h2 class="card-text">{{ stats.total_tasks }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title">Completed Tasks</h5>
                    <h2 class="card-text">{{ stats.completed_tasks }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Completion Rate</h5>
                    <h2 class="card-text">{{ "%.1f"|format(stats.completion_rate) }}%</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <button class="btn btn-primary w-100 mb-2" onclick="loadUsers()">
                                <i class="bi bi-people"></i> View All Users
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-success w-100 mb-2" onclick="loadTasks()">
                                <i class="bi bi-list-task"></i> View All Tasks
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-info w-100 mb-2" onclick="refreshStats()">
                                <i class="bi bi-graph-up"></i> Refresh Stats
                            </button>
                        </div>
                        <div class="col-md-3">
                            <a href="/" class="btn btn-secondary w-100 mb-2">
                                <i class="bi bi-house"></i> Back to Main
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Tables -->
    <div class="row">
        <!-- Users Table -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Users Management</h5>
                    <button class="btn btn-sm btn-primary" onclick="loadUsers()">Refresh</button>
                </div>
                <div class="card-body">
                    <div id="users-table">
                        <p class="text-muted">Click "View All Users" to load user data</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tasks Table -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Tasks Management</h5>
                    <button class="btn btn-sm btn-success" onclick="loadTasks()">Refresh</button>
                </div>
                <div class="card-body">
                    <div id="tasks-table">
                        <p class="text-muted">Click "View All Tasks" to load task data</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Admin Dashboard -->
<script>
let authToken = localStorage.getItem('access_token');

async function loadUsers() {
    try {
        const response = await fetch('/admin/users', {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (response.ok) {
            const users = await response.json();
            displayUsers(users);
        } else {
            alert('Failed to load users. Please check your authentication.');
        }
    } catch (error) {
        console.error('Error loading users:', error);
        alert('Error loading users');
    }
}

async function loadTasks() {
    try {
        const response = await fetch('/admin/tasks', {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (response.ok) {
            const tasks = await response.json();
            displayTasks(tasks);
        } else {
            alert('Failed to load tasks. Please check your authentication.');
        }
    } catch (error) {
        console.error('Error loading tasks:', error);
        alert('Error loading tasks');
    }
}

function displayUsers(users) {
    const table = `
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${users.map(user => `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.name}</td>
                            <td>${user.email}</td>
                            <td><span class="badge bg-${user.role === 'admin' ? 'danger' : 'secondary'}">${user.role}</span></td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="editUser(${user.id})">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">Delete</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    document.getElementById('users-table').innerHTML = table;
}

function displayTasks(tasks) {
    const table = `
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Owner ID</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${tasks.map(task => `
                        <tr>
                            <td>${task.id}</td>
                            <td>${task.task_title}</td>
                            <td>${task.owner_id}</td>
                            <td><span class="badge bg-${task.is_completed ? 'success' : 'warning'}">${task.is_completed ? 'Completed' : 'Pending'}</span></td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="editTask(${task.id})">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteTask(${task.id})">Delete</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    document.getElementById('tasks-table').innerHTML = table;
}

async function refreshStats() {
    try {
        const response = await fetch('/admin/stats', {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (response.ok) {
            const stats = await response.json();
            // Update the stats display
            location.reload(); // Simple refresh for now
        } else {
            alert('Failed to refresh stats');
        }
    } catch (error) {
        console.error('Error refreshing stats:', error);
        alert('Error refreshing stats');
    }
}

// Placeholder functions for edit/delete operations
function editUser(userId) {
    alert(`Edit user ${userId} - Implement edit functionality`);
}

function deleteUser(userId) {
    if (confirm(`Are you sure you want to delete user ${userId}?`)) {
        // Implement delete functionality
        alert(`Delete user ${userId} - Implement delete functionality`);
    }
}

function editTask(taskId) {
    alert(`Edit task ${taskId} - Implement edit functionality`);
}

function deleteTask(taskId) {
    if (confirm(`Are you sure you want to delete task ${taskId}?`)) {
        // Implement delete functionality
        alert(`Delete task ${taskId} - Implement delete functionality`);
    }
}
</script>
{% endblock %}
